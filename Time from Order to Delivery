DECLARE @TempTable TABLE (
    Store VARCHAR(100),
    SalesOrderNumber varchar(100),
    Delivery_Date datetime2,
    Fulfilled_Date datetime2,
    Warehouse VARCHAR(100),
    order_category VARCHAR (100),
    CORE_PHP INT
)

INSERT INTO @TempTable (Store, SalesOrderNumber, Delivery_Date,Fulfilled_Date, Warehouse)
SELECT s.Store,
       s.SalesOrderNumber,
       sf.StatusDate,
       sf2.StatusDate,
       CASE WHEN f.warehouse  = 'MANSCAPED-DTC' THEN 'FSD-Baja'
       WHEN f.warehouse = 'Texas' Then 'FSD-Reynosa'
       Else f.warehouse END As 'Warehouse'
FROM SourceSystemDim ss
INNER JOIN SalesOrderStatusDim sos2 ON  sos2.Status = 'Fulfilled'
INNER JOIN SalesOrderStatusFact sf2 ON  ss.SourceSystemId = sf2.SourceSystemId AND sos2.SalesOrderStatusId = sf2.SalesOrderStatusId
LEFT JOIN SalesOrderStatusDim sos ON sos.Status = 'Delivered'
LEFT JOIN SalesOrderStatusFact sf ON sos.SalesOrderStatusId = sf.SalesOrderStatusId AND sf.SourceSystemId = sf2.SourceSystemId and sf.SalesOrderId = sf2.SalesOrderId
INNER JOIN SalesOrderDim s ON sf2.SalesOrderId = s.SalesOrderId
INNER JOIN fpa3pl f ON s.salesordernumber =f.ordernumber
WHERE ss.SourceSystemName = 'Shiphero' and sf2.statusdate >='2023-8-01'

INSERT INTO @temptable (order_category,CORE_PHP)
Select 
soh.WebSubOther,
CASE WHEN i.IScorePHP =1 AND so.lineitem_quantity =1 THEN '1' ELSE 0 END
FROM ItemDIM i 
INNER JOIN ShopifyOrders so ON i.sku = so.lineitem_sku
INNER JOIN ShopifyOrdersHeader soh ON so.ordernumber =soh.ordernumber
Where so.store = 'MAN-US' AND soh.period >=202308

SELECT t.warehouse,t.SalesOrderNumber, t.Delivery_Date, t.Fulfilled_Date, soh.Created_at As 'Ordered_Date', DateDiff (day,Fulfilled_Date,Delivery_Date) AS 'Days In Transit', DateDiff(day,soh.Created_at, Fulfilled_Date) AS 'Days To Fulfill',
soh.Shipping_Province,CASE WHEN order_category = 'Web' Then 'Web' WHEN CORE_PHP= '1' THEN 'CORE_PHP' ElSE 'PHP & LEGACY' END AS 'ORDER_TYPE'
from @TempTable t
INNER JOIN ShopifyOrdersHeader soh  ON t.Store = soh.Store AND t.SalesOrderNumber = soh.OrderNumber
WHERE soh.store = 'MAN-US' AND soh.period >=202308
